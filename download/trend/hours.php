<?php//полное кодичество скачиваний за последний месяц$cachefile= './tmp/hours.tmp';include $_SERVER['DOCUMENT_ROOT']."/engine/data/dbconfig.php";include("pChart/pData.class");include("pChart/pChart.class");    $db1=mysql_connect(DBHOST2, DBUSER2,DBPASS2) or    die("Could not connect: " . mysql_error());    mysql_select_db(DBNAME2,$db1);    mysql_query("SET NAMES ".COLLATE2,$db1);        echo "<table border=1>";  //@include $cachefile;       $data=@unserialize(file_get_contents($cachefile));   //echo "<pre>";print_r($data);   $where='';   if(!empty($data))       {       end($data);       $date=key($data); $where=" and DATE_FORMAT( created,  '%Y-%m-%d_%H' )>='".$date."'";       }   //echo $where;   //die();           $sql="SELECT DATE_FORMAT( created,  '%Y-%m-%d_%H' ) as created, COUNT( catalog_group_id ) AS  `count` FROM  `fl_catalog_clicks` WHERE  `created` > DATE_SUB( CURDATE( ) , INTERVAL 1 WEEK ) AND catalog_sgroup_id =2 {$where}GROUP BY DATE_FORMAT( created,  '%Y-%m-%d_%H' ) order by created";echo $sql;    $result=mysql_query($sql,$db1);    $rows=array();$ids=array();    while($row=mysql_fetch_assoc($result))    {        $serie[$row['created']]=$row['count'];    }if(is_array($data))$serie= array_merge($data,$serie);$serie3=array_keys($serie);foreach($serie3 as $k=>$v){if($i%12==0)$serie4[$k]=$serie3[$k];else $serie4[$k]="";$i++;}       $handler = @fopen($cachefile, "w");       //array_pop($serie);       fwrite($handler,serialize($serie));       fclose($handler);if(count($serie4)>1)prgrath(date('d-m-Y_H'),$serie,array(),$serie4);else echo "no graph\n<br>";function prgrath($id,$serie1,$serie2=array(),$serie3=null,$serie6=array(),$title=""){ @unlink("m_".$id.".png"); // Dataset definition  $DataSet = new pData; $DataSet->AddPoint($serie1,"Serie1"); $DataSet->AddPoint($serie2,"Serie2"); foreach ($serie6 as $k=>$v)$DataSet->AddPoint($v,"id_".$k); $DataSet->AddPoint($serie3,"Serie3");  $DataSet->AddAllSeries(); $DataSet->SetAbsciseLabelSerie("Serie3"); $DataSet->SetSerieName("Num","Serie1"); $DataSet->SetSerieName("Publication","Serie2"); foreach ($serie6 as $k=>$v)$DataSet->SetSerieName("link ".$k,"id_".$k); $DataSet->SetSerieName("Updates","Serie3"); //print_r($DataSet->GetData()); // Initialise the graph $Test = new pChart(1000,500); //$Test->setFixedScale(-2,8); $Test->setFontProperties("Fonts/tahoma.ttf",8); $Test->setGraphArea(100,30,850,450); $Test->drawFilledRoundedRectangle(7,7,1000,500,5,240,240,240); $Test->drawRoundedRectangle(5,5,1000,500,5,230,230,230); $Test->drawGraphArea(255,255,255,TRUE); $Test->drawScale($DataSet->GetData(),$DataSet->GetDataDescription(),SCALE_NORMAL,150,150,150,TRUE,0,2); $Test->drawGrid(4,TRUE,230,230,230,50);                                 // Draw the 0 line $Test->setFontProperties("Fonts/tahoma.ttf",6); $Test->drawTreshold(0,143,55,72,TRUE,TRUE); // Draw the cubic curve graph $DataSet->RemoveSerie("Serie2"); $Test->drawLineGraph($DataSet->GetData(),$DataSet->GetDataDescription()); $Test->drawLimitsGraph($DataSet->GetData(),$DataSet->GetDataDescription()); $Test->drawPlotGraph($DataSet->GetData(),$DataSet->GetDataDescription());  $DataSet->RemoveSerie("Serie1"); $DataSet->RemoveSerie("Serie3"); foreach ($serie6 as $k=>$v)$DataSet->RemoveSerie("id_".$k); $DataSet->AddSerie("Serie2");// Draw the limit graph $Test->drawLimitsGraph($DataSet->GetData(),$DataSet->GetDataDescription(),180,180,180); // Finish the graph $Test->setFontProperties("Fonts/tahoma.ttf",8); $Test->drawLegend(900,30,$DataSet->GetDataDescription(),255,255,255); $Test->setFontProperties("Fonts/tahoma.ttf",10); //echo iconv('windows-1251','utf-8',$title); $Test->drawTitle(50,22,$title,50,50,50,585); $Test->Render("m_".$id.".png"); echo "<br><a href='m_{$id}.png'><img src='m_{$id}.png'></a>";}?>